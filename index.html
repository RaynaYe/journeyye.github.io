// HwClient.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <winsock2.h>
#include <iostream>
#include <string>

#pragma comment(lib,"Ws2_32.lib")
using namespace std;

#define BUFFERSIZE 100

void DisplayHint();

int main(int argc, char* argv[])
{
	if(argc !=3)
	{
		cout<<"usage:"<<"HwClient serverip  serverport"<<endl;
		return 0;
	}
   
	WORD wVersion;
	WSAData wData;
	SOCKET  tcpS,udpS;
	sockaddr_in remote;
	int choice;	
	char choiceBuf[10];
	int err;
	int udpPort;
	
    int ret;
	int addrLen;
	char recvBuf[BUFFERSIZE] = "";
	char sendBuf[BUFFERSIZE] = "";
		
	wVersion = MAKEWORD(2,2);
	err = WSAStartup(wVersion,&wData);
	if(err !=0)
	{
		cout<<"Fail to laod socket dll:"<<endl;		
		return 0;
	}

    //------------------------
	tcpS = WSASocket(AF_INET,SOCK_STREAM,IPPROTO_TCP,NULL,0,0);
	if(tcpS == INVALID_SOCKET)
	{		
		cout<<"Error code:"<<GetLastError()<<endl;
		WSACleanup();
		return 0;
	}	
	
	 
    remote.sin_family = AF_INET;
    remote.sin_addr.s_addr = inet_addr(argv[1] );   // server ip
    remote.sin_port =  htons(atoi(argv[2])) ;        // server port
	err = connect( tcpS, (SOCKADDR*) &remote, sizeof(remote) );
	if(err == SOCKET_ERROR) 
	{
		cout<<"Failed to connect"<<WSAGetLastError()<<endl ;
        WSACleanup();
        return 0;
	}
	
//	ret = SOCKET_ERROR;
	while(1)
	{
		ret = recv(tcpS,recvBuf,BUFFERSIZE,0);
		cout<<recvBuf<<endl;
		
		do
		{
			cout<<"input : GET UDP PORT"<<endl;
		    cin.getline(sendBuf,20);
			if(strcmp(sendBuf,"GET UDP PORT") !=0)
				cout<<"Bad request."<<endl;
		}while(strcmp(sendBuf,"GET UDP PORT") !=0);
			
		ret = send(tcpS,sendBuf,strlen(sendBuf),0);
		if(ret == SOCKET_ERROR)
		{
			cout<<"send() failed:"<<WSAGetLastError()<<endl;
			break;
		}
		
		//receive udp port
		memset(recvBuf,0,BUFFERSIZE);
		ret = recv(tcpS,recvBuf,BUFFERSIZE,0);   
		udpPort = atoi(recvBuf);
		cout<<"udp port is:"<<udpPort<<endl;		
        
		//------------------------------
		//create udp socket
		udpS = WSASocket(AF_INET,SOCK_DGRAM,IPPROTO_UDP,NULL,
		                          0,WSA_FLAG_OVERLAPPED);
	    if(udpS == INVALID_SOCKET)
		{
			cout<<"create udp socket error:"<<WSAGetLastError()<<endl;
		   	return 0;
		}	  
		
        do{
			DisplayHint();
			memset(choiceBuf,0,BUFFERSIZE);
	        cin.getline(choiceBuf,BUFFERSIZE);
            choice = atoi(choiceBuf);
	    	switch(choice)
			{
				case 1:
					strcpy(sendBuf,"GET CUR TIME");
					ret = send(tcpS,sendBuf,strlen(sendBuf),0);			
			        if(ret == SOCKET_ERROR)
					{
						cout<<"send() failed:"<<WSAGetLastError()<<endl;
						break;
					}
					memset(recvBuf,0,BUFFERSIZE);
					ret = recv(tcpS,recvBuf,BUFFERSIZE,0);
			        cout<<"Current time is: "<<recvBuf<<endl;
			        break;

				 case 2:
					cout<<"Enter your message:"<<endl;
					memset(sendBuf,0,BUFFERSIZE);
			        cin.getline(sendBuf,BUFFERSIZE);
                    remote.sin_family = AF_INET;
					remote.sin_port = htons(udpPort);
					remote.sin_addr.s_addr = inet_addr(argv[1]);					
					ret = sendto(udpS,sendBuf,strlen(sendBuf),0,
						                           (SOCKADDR*)&remote,sizeof(remote));
					if(ret == SOCKET_ERROR)
					{
						cout<<"sendto() failed:"<<WSAGetLastError()<<endl;
					}
					
					sockaddr_in from;
					addrLen = sizeof(from);
					memset(recvBuf,0,BUFFERSIZE);
					ret = recvfrom(udpS,recvBuf,BUFFERSIZE,0,
						                 (SOCKADDR*)&from,&addrLen);
					cout<<recvBuf<<" from:"<<inet_ntoa(from.sin_addr)<<":"
						<<ntohs(from.sin_port)<<endl;
				    break;

				 case 3:
					closesocket(udpS);
					closesocket(tcpS);
					WSACleanup();
					return 0;
					break;
		       default:
				   cout<<"Bad choice,must be 1-3"<<endl;
			       break;
			}
		}while(choice != 3);
		
		//break;
	}
	
    WSACleanup();	 
	return 0;
}

void DisplayHint()
{
	cout<<"Enter your choise:"<<endl;
	cout<<" 1. Get current time(TCP)"<<endl;
	cout<<" 2. Echo Mode(UDP)"<<endl;
	cout<<" 3. Exit the program"<<endl;
}

